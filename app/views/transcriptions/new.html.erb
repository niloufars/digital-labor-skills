<script>
	var handler = function (e) { 
		handler.timestamp.push(e.timeStamp);


		if ( first_stroke ){
			first_stroke = false;
			handler.beginTime = handler.timestamp[0];

		}

		var n = handler.timestamp.length;
		handler.endTime = handler.timestamp[n-1];
		handler.keycount++;

		if ( handler.timestamp[n-1]-handler.timestamp[n-2] > 10000 ){
			handler.idleTime += handler.timestamp[n-1]-handler.timestamp[n-2];
		}
		document.getElementById('keystroke').value = 'begin: ' + handler.beginTime + ', end: ' + handler.endTime + ', keycount: '+ handler.keycount + ', idleTime: ' + handler.idleTime;

	}
	function sendTrackerData(timeAt) {
	    var xmlhttp;

	    if (window.XMLHttpRequest) {
	        // code for IE7+, Firefox, Chrome, Opera, Safari
	        xmlhttp = new XMLHttpRequest();
	    } else {
	        // code for IE6, IE5
	        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
	    }

	    xmlhttp.onreadystatechange = function() {
	        if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
	           if(xmlhttp.status == 200){
	               alert("saved");
	           }
	           else if(xmlhttp.status == 400) {
	              alert('There was an error 400')
	           }
	           else {
	               alert('something else other than 200 was returned')
	               alert(xmlhttp.status);
	           }
	        }
	    }
	    
		xmlhttp.open("post", "/trackers");
		var formData = new FormData();
		formData.append('workerID', document.getElementById('worker_id_box').innerHTML);
		formData.append('audioID', document.getElementById('audio_id_box').innerHTML);
		formData.append('timeAt', timeAt);
		formData.append('keyCount', handler.keycount);
		xmlhttp.send(formData);
	    
	}
	var ti = 240;
	function startTime() {
	    document.getElementById('timer').innerHTML = parseInt(ti/60) + ':' + ti%60;
	    if ( ti<10 ){
	    	document.getElementById('timer').style.color = "red";
	    }
	    if ( ti % 60 == 0 ){
	    	sendTrackerData(ti);
	    } 
	    if ( ti==0 ){
	    	document.getElementById('timer').innerHTML = "Your time is over, please submit the HIT before it expires."
	    	document.getElementById('timer').style.fontSize = "110%";
	    	document.getElementById('data').disabled = "disabled";
	    }
	    ti = ti-1;
	    if ( ti>=0 )
		    setTimeout(startTime, 1000);

	}
	first_stroke = true;
	handler.beginTime = 0;
	handler.endTime = 0;
	handler.keycount = 0;
	handler.idleTime = 0;
	handler.timestamp = [];
	window.addEventListener("keyup", handler);
	document.body.onload = function () {
		
		if ( document.getElementById('assignment_id_box').innerHTML != 'ASSIGNMENT_ID_NOT_AVAILABLE'){
			document.getElementById('preview_div').style.display = 'none';
			document.getElementById('task_div').style.display = 'inline';
			if ( document.getElementById('audio_time_box').innerHTML === 't' ){
				if ( document.getElementById('timer_amount_box').innerHTML === '5' )
					ti = 300;
				startTime();
			}
		}
	}
</script>

<div id="preview_div">
	

		<% if @review == 'g' or @review == 'b' %>
			<h1>Transcription review task</h1>
			<p>In this task you will be given a five minute audio clip and a transcription. Your task is to listen to the audio and fix any problems in the transcription or fill in any missing parts.</p>
			<p>You will see the audio clip after you accept the task.</p>
		<% else %>
			<h1>Transcription task</h1>
			<p>In this task you will be given a one minute audio clip to transcribe. We are aiming at a near real-time transcription so you will have <span style="text-decoration: underline">4 minutes</span> to complete the task.</p>
			<p>If you achieve a 60% accuracy with the audio your work will be a accepted. If your accuracy is between 50-60% you will be given a chance to fix your errors.</p>
			<p>You will see the audio clip after you accept the task.</p>
		<% end %>



	</div>

	<div id="task_div"  style="display:none">
		<h1>New Transcription</h1>
		
		<% if @review == 'g' or @review == 'b' %>
			<p>In this task you will be given a five minute audio clip and a transcription. Your task is to listen to the audio and fix any problems in the transcription or fill in any missing parts.</p>
			<p>If you have any questions, email us at researchproject97@gmail.com</p>
		<% elsif @review == 'p' %>
			<p>This is a <span style="text-decoration: underline">timed task</span>, once accepted you have 4 minutes to complete the task, be mindful of your time. </p> 
			<p>If you achieve a 60% accuracy with the audio your work will be a accepted and you will earn 50 cents. Your earnings will increase with your accuracy, up to a maximum of $1, as illustrated in the figure below. The extra payment will be made through a bonus. If your accuracy is between 50-60% you will be given a chance to fix your errors and earn the base pay. </p>
			<%= image_tag("Contract3.png", :alt => "bonus", :width => "400px") %>

			<p>Listen to the following audio clip and transcribe it:</p>
		<% else %>
			<p>This is a <span style="text-decoration: underline">timed task</span>, once accepted you have 4 minutes to complete the task, be mindful of your time. </p> 
			<p>If you achieve a 60% accuracy with the audio your work will be a accepted and you will earn 50 cents (if your accuracy is between 50-60% you will be given a chance to fix your errors). </p>
			<p>If you have any questions, email us at researchproject97@gmail.com</p>

			<p>Listen to the following audio clip and transcribe it:</p>
				
		<% end %>
		<div style="display: none;" id="assignment_id_box"><%= @assignment_id  %></div>
		<div style="display: none;" id="worker_id_box"><%= @worker_id  %></div>
		<div style="display: none;" id ="audio_id_box"><%= @audioid %></div>
		
		<div style="display: none;" id ="audio_time_box"><% if @audioid === "p1t1" || @audioid === "p1gt2" || @audioid === "p1bt2" %>nt<% else %>t<%end%></div>
		<div style="display: none;" id ="timer_amount_box"><% if @audioid === "p1t5" %>5<% else %>4<%end%></div>
		<audio controls>
			<source src= <%= "https://stanford.edu/~niloufar/audio/"+@audioid+".mp3" %> type="audio/mpeg">
			Your browser does not support the audio element.
		</audio>
		<br><br>
		<div id="timer" style="font-size: 200%"></div>
		<%= render 'form' %>

	</div>
